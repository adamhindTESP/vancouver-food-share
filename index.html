<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üçÖ Vancouver Food Share</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 680px;
      margin: 0 auto;
      padding: 18px;
      background: #f8f9fa;
      color: #111827;
    }
    .card {
      background: white;
      border-radius: 14px;
      padding: 22px;
      margin: 14px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid #eef2f7;
    }
    h1 { font-size: 34px; line-height: 1.1; margin-bottom: 10px; }
    h2 { font-size: 24px; margin: 10px 0 8px; }
    p { color: #374151; line-height: 1.35; }
    .muted { color: #6b7280; }
    .small { font-size: 13px; }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #e5e7eb;
      color: #374151;
      background: #f9fafb;
      margin-top: 8px;
    }
    button, input, select, textarea {
      width: 100%;
      padding: 12px;
      margin: 9px 0;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #fff;
    }
    textarea { min-height: 86px; resize: vertical; }
    button {
      background: #10b981;
      color: white;
      font-weight: 700;
      cursor: pointer;
      border: none;
    }
    button.secondary {
      background: #6b7280;
      width: auto;
      padding: 10px 14px;
      display: inline-block;
      border-radius: 10px;
    }
    button.ghost {
      background: #fff;
      color: #111827;
      border: 1px solid #d1d5db;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .mode-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }
    .mode-btn {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 14px;
      padding: 16px;
      cursor: pointer;
      font-weight: 700;
      color: #111827;
    }
    .mode-btn:hover { border-color: #10b981; }

    .banner {
      background: #fff7ed;
      border-left: 4px solid #fb923c;
      padding: 12px 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    .info {
      background: #dbeafe;
      border-left: 4px solid #3b82f6;
      padding: 12px;
      margin: 12px 0;
      border-radius: 10px;
      color: #111827;
    }
    .success {
      background: #dcfce7;
      border-left: 4px solid #16a34a;
      padding: 12px;
      border-radius: 10px;
      margin: 12px 0;
    }
    .warn {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      padding: 12px;
      border-radius: 10px;
      margin: 12px 0;
      color: #111827;
    }
    .food-item {
      background: #f0fdf4;
      border-left: 5px solid #10b981;
      padding: 14px;
      border-radius: 12px;
      margin: 12px 0;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .row > * { flex: 1; }
    .footer {
      text-align: center;
      font-size: 13px;
      color: #6b7280;
    }
    .linklike {
      color: #2563eb;
      text-decoration: underline;
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      cursor: pointer;
      font-size: 13px;
    }
    .divider { height: 1px; background: #e5e7eb; margin: 12px 0; }
    .right { text-align: right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>

<body>

  <!-- HEADER -->
  <div class="card">
    <h1>üçÖ Vancouver Food Share</h1>
    <p class="muted">Safe public pickup only. Drop food ‚Üí list it ‚Üí anyone can pick up.</p>
    <div class="banner small">
      <strong>Pilot project.</strong> Locations and partners are being verified. Please use only safe public pickup points.
    </div>
    <div class="pill">üõ°Ô∏è Guardian active ¬∑ Fair-share limits ¬∑ No accounts ¬∑ No tracking</div>
  </div>

  <!-- HOME / ROLE SELECT -->
  <div class="card" id="screenHome">
    <h2 style="text-align:center;">What brings you here?</h2>
    <p style="text-align:center;color:#6b7280;">Choose one option to continue.</p>

    <div class="mode-toggle">
      <button class="mode-btn" id="btnGive">ü•¨ I Have Food</button>
      <button class="mode-btn" id="btnGet">ü•ó I Need Food</button>
    </div>

    <div class="divider"></div>

    <p class="small muted">
      Want to help store food (business/community space)?
      <button class="linklike" id="openPartner">Apply as a storage partner</button>
    </p>
  </div>

  <!-- GIVE MODE -->
  <div class="card" id="screenGive" style="display:none;">
    <div class="row">
      <button class="secondary" id="backFromGive">‚Üê Back</button>
      <div class="right small muted">Listings expire in <strong>24 hours</strong>.</div>
    </div>

    <h2>Drop Food ‚Üí List It</h2>

    <div class="success small">
      <strong>Step 1:</strong> Drop food at a safe public spot (or verified partner location)<br>
      <strong>Step 2:</strong> List it here so others can find it
    </div>

    <label class="small muted">Food description</label>
    <input id="giveFoodType" maxlength="80" placeholder="e.g. apples, bread, vegetables (sealed preferred)" />

    <label class="small muted">Area / neighbourhood (not an exact home address)</label>
    <input id="giveArea" maxlength="60" placeholder="e.g. Commercial‚ÄìBroadway, Kits, Metrotown" />

    <label class="small muted">Pickup instructions (optional)</label>
    <textarea id="giveNotes" maxlength="180" placeholder="e.g. ‚ÄòInside lobby by mailboxes‚Äô (keep it public + safe)"></textarea>

    <label class="row small" style="align-items:flex-start;">
      <input type="checkbox" id="droppedCheck" style="width:auto; margin-top:3px;" />
      <span>
        Food is already dropped off (required)
        <div class="small muted">This prevents ‚Äúphantom listings.‚Äù</div>
      </span>
    </label>

    <button id="listBtn" disabled>List for pickup (24h)</button>

    <div class="warn small">
      <strong>Safety note:</strong> Do not post exact residential addresses. Use public, safe pickup points only.
    </div>
  </div>

  <!-- GET MODE -->
  <div class="card" id="screenGet" style="display:none;">
    <div class="row">
      <button class="secondary" id="backFromGet">‚Üê Back</button>
      <button class="ghost" id="refreshBtn">Refresh</button>
    </div>

    <h2>Food Listings</h2>
    <p class="muted small">How many people are you feeding? (max 4)</p>

    <select id="familySize">
      <option value="1">1 person</option>
      <option value="2">2 people</option>
      <option value="3">3 people</option>
      <option value="4">4 people</option>
    </select>

    <div class="info" id="guardianInfo"></div>

    <div id="foodList"></div>

    <div class="divider"></div>
    <p class="small muted">
      See something unsafe or spammy?
      <button class="linklike" id="clearLocal">Clear my device‚Äôs local data</button>
    </p>
  </div>

  <!-- STORAGE PARTNER / SPONSOR APPLY -->
  <div class="card" id="screenPartner" style="display:none;">
    <div class="row">
      <button class="secondary" id="backFromPartner">‚Üê Back</button>
      <div class="right small muted">For businesses & community spaces</div>
    </div>

    <h2>Storage Partner Application</h2>
    <p class="muted">
      If you can host a safe pickup point (fridge/shelf/desk), apply here.
      <strong>This is an application only ‚Äî not automatic approval.</strong>
    </p>

    <label class="small muted">Place name</label>
    <input id="partnerName" maxlength="80" placeholder="e.g. Friendly Caf√©, Community Center" />

    <label class="small muted">Neighbourhood / general address</label>
    <input id="partnerArea" maxlength="80" placeholder="e.g. Mount Pleasant (near Main St)" />

    <label class="small muted">Storage type</label>
    <select id="partnerStorage">
      <option value="">Select‚Ä¶</option>
      <option value="fridge">Has a fridge</option>
      <option value="shelf">Has a shelf / dry storage</option>
      <option value="desk">Has a front desk / staff handoff</option>
    </select>

    <label class="small muted">Contact (optional)</label>
    <input id="partnerContact" maxlength="80" placeholder="Email or phone (optional)" />

    <button id="partnerApplyBtn">Submit application</button>

    <div class="info small" id="partnerThanks" style="display:none;"></div>

    <div class="divider"></div>

    <h3 style="margin:10px 0 6px;">Approved locations</h3>
    <p class="small muted" id="approvedLocationsText">
      None yet. We‚Äôre verifying partners. (You can add approved locations later once confirmed.)
    </p>
  </div>

  <div class="card footer">
    üõ°Ô∏è Guardian active ¬∑ Fair-share limits ¬∑ No accounts ¬∑ No tracking
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // --------- CONFIG ----------
      const KG_PER_PERSON = 2.5;
      const MAX_PEOPLE = 4;
      const LISTING_TTL_MS = 24 * 60 * 60 * 1000; // 24 hours
      const MAX_LISTINGS_PER_DEVICE_PER_DAY = 10;

      // Very simple spam filter (not perfect, but helps)
      const BANNED_SUBSTRINGS = [
        "bitcoin", "glory hole", "shooters", "weapon", "guns", "cocaine",
        "meth", "sex", "porn", "kill", "murder"
      ];

      // --------- STORAGE KEYS ----------
      const KEY_FOOD = "vfs_food_v2";
      const KEY_POSTLOG = "vfs_postlog_v2";
      const KEY_PARTNER_APPS = "vfs_partner_apps_v1";

      // --------- ELEMENTS ----------
      const screenHome = document.getElementById("screenHome");
      const screenGive = document.getElementById("screenGive");
      const screenGet = document.getElementById("screenGet");
      const screenPartner = document.getElementById("screenPartner");

      const btnGive = document.getElementById("btnGive");
      const btnGet = document.getElementById("btnGet");
      const openPartner = document.getElementById("openPartner");

      const backFromGive = document.getElementById("backFromGive");
      const backFromGet = document.getElementById("backFromGet");
      const backFromPartner = document.getElementById("backFromPartner");

      const giveFoodType = document.getElementById("giveFoodType");
      const giveArea = document.getElementById("giveArea");
      const giveNotes = document.getElementById("giveNotes");
      const droppedCheck = document.getElementById("droppedCheck");
      const listBtn = document.getElementById("listBtn");

      const familySize = document.getElementById("familySize");
      const guardianInfo = document.getElementById("guardianInfo");
      const foodList = document.getElementById("foodList");
      const refreshBtn = document.getElementById("refreshBtn");
      const clearLocal = document.getElementById("clearLocal");

      const partnerName = document.getElementById("partnerName");
      const partnerArea = document.getElementById("partnerArea");
      const partnerStorage = document.getElementById("partnerStorage");
      const partnerContact = document.getElementById("partnerContact");
      const partnerApplyBtn = document.getElementById("partnerApplyBtn");
      const partnerThanks = document.getElementById("partnerThanks");
      const approvedLocationsText = document.getElementById("approvedLocationsText");

      // --------- STATE ----------
      let food = safeParse(localStorage.getItem(KEY_FOOD), []);
      let postlog = safeParse(localStorage.getItem(KEY_POSTLOG), { day: todayKey(), count: 0 });
      let partnerApps = safeParse(localStorage.getItem(KEY_PARTNER_APPS), []);

      // Daily reset of post log
      if (postlog.day !== todayKey()) {
        postlog = { day: todayKey(), count: 0 };
        localStorage.setItem(KEY_POSTLOG, JSON.stringify(postlog));
      }

      // --------- NAV ----------
      function show(screen) {
        screenHome.style.display = "none";
        screenGive.style.display = "none";
        screenGet.style.display = "none";
        screenPartner.style.display = "none";
        screen.style.display = "block";
        window.scrollTo(0, 0);
      }

      btnGive.onclick = () => show(screenGive);
      btnGet.onclick = () => { show(screenGet); updateGetDisplay(); };
      openPartner.onclick = () => { show(screenPartner); renderApprovedLocations(); };

      backFromGive.onclick = () => show(screenHome);
      backFromGet.onclick = () => show(screenHome);
      backFromPartner.onclick = () => show(screenHome);

      refreshBtn.onclick = () => updateGetDisplay();

      clearLocal.onclick = () => {
        if (!confirm("Clear local data for this device? This only affects your device.")) return;
        localStorage.removeItem(KEY_FOOD);
        localStorage.removeItem(KEY_POSTLOG);
        localStorage.removeItem(KEY_PARTNER_APPS);
        food = [];
        partnerApps = [];
        postlog = { day: todayKey(), count: 0 };
        alert("Cleared local data on this device.");
        updateGetDisplay();
      };

      // --------- GIVE FLOW ----------
      droppedCheck.onchange = () => {
        listBtn.disabled = !droppedCheck.checked;
      };

      listBtn.onclick = () => {
        const item = (giveFoodType.value || "").trim();
        const area = (giveArea.value || "").trim();
        const notes = (giveNotes.value || "").trim();

        // Basic validation
        if (!item || !area) return alert("Please add food description + area/neighbourhood.");
        if (!droppedCheck.checked) return alert("Please confirm the food is already dropped off.");

        // Anti-spam: daily per-device cap
        if (postlog.count >= MAX_LISTINGS_PER_DEVICE_PER_DAY) {
          return alert("Listing limit reached for this device today. Try again tomorrow.");
        }

        // Anti-troll: banned words
        const combined = (item + " " + area + " " + notes).toLowerCase();
        if (containsBanned(combined)) {
          return alert("That listing looks unsafe/inappropriate. Please keep it food-only and public-safe.");
        }

        // Discourage exact addresses (simple heuristic)
        if (looksLikeExactAddress(area) || looksLikeExactAddress(notes)) {
          return alert("Please don‚Äôt post exact addresses. Use neighbourhood + public pickup instructions only.");
        }

        const now = Date.now();
        const listing = {
          id: "l_" + now + "_" + Math.random().toString(16).slice(2),
          item,
          area,
          notes,
          createdAt: now,
          expiresAt: now + LISTING_TTL_MS
        };

        food.unshift(listing);
        localStorage.setItem(KEY_FOOD, JSON.stringify(food));

        postlog.count += 1;
        localStorage.setItem(KEY_POSTLOG, JSON.stringify(postlog));

        // Reset form
        giveFoodType.value = "";
        giveArea.value = "";
        giveNotes.value = "";
        droppedCheck.checked = false;
        listBtn.disabled = true;

        alert("‚úÖ Listed for pickup (expires in 24 hours).");
        show(screenGet);
        updateGetDisplay();
      };

      // --------- GET FLOW ----------
      familySize.onchange = updateGetDisplay;

      function updateGetDisplay() {
        pruneExpired();

        const people = Math.min(parseInt(familySize.value || "1", 10), MAX_PEOPLE);
        const limitKg = people * KG_PER_PERSON;

        guardianInfo.innerHTML =
          `To keep things fair, you may take up to <strong>${limitKg.toFixed(1)}kg</strong> today. ` +
          `<span class="small muted">(Pilot limit ¬∑ max ${MAX_PEOPLE} people)</span>`;

        if (!food.length) {
          foodList.innerHTML = `<p class="muted"><em>No food available right now. Check back later.</em></p>`;
          return;
        }

        foodList.innerHTML = food.map(f => {
          const minutesLeft = Math.max(0, Math.floor((f.expiresAt - Date.now()) / 60000));
          const hoursLeft = Math.floor(minutesLeft / 60);
          const mins = minutesLeft % 60;
          const timeLeft = hoursLeft > 0 ? `${hoursLeft}h ${mins}m` : `${mins}m`;

          return `
            <div class="food-item">
              <div style="display:flex; justify-content:space-between; gap:10px;">
                <div>
                  <div style="font-size:18px; font-weight:800;">${escapeHtml(f.item)}</div>
                  <div class="small muted">üìç ${escapeHtml(f.area)}</div>
                  ${f.notes ? `<div class="small muted">üìù ${escapeHtml(f.notes)}</div>` : ""}
                </div>
                <div class="small muted right">
                  <div class="mono">‚è± ${timeLeft}</div>
                  <div class="mono">expires</div>
                </div>
              </div>
            </div>
          `;
        }).join("");
      }

      function pruneExpired() {
        const now = Date.now();
        const before = food.length;
        food = food.filter(f => typeof f.expiresAt === "number" && f.expiresAt > now);
        if (food.length !== before) {
          localStorage.setItem(KEY_FOOD, JSON.stringify(food));
        }
      }

      // --------- PARTNER APPLY ----------
      partnerApplyBtn.onclick = () => {
        const name = (partnerName.value || "").trim();
        const area = (partnerArea.value || "").trim();
        const storage = (partnerStorage.value || "").trim();
        const contact = (partnerContact.value || "").trim();

        if (!name || !area || !storage) {
          return alert("Please fill: place name, area, and storage type.");
        }

        const combined = (name + " " + area + " " + contact).toLowerCase();
        if (containsBanned(combined)) {
          return alert("That application looks unsafe/inappropriate. Please keep it clean and accurate.");
        }

        partnerApps.unshift({
          name, area, storage, contact,
          submittedAt: Date.now()
        });

        localStorage.setItem(KEY_PARTNER_APPS, JSON.stringify(partnerApps));

        partnerThanks.style.display = "block";
        partnerThanks.innerHTML =
          `‚úÖ Thanks! Application saved on this device (pilot mode).<br>` +
          `<span class="small muted">Next step: you (Adam) verify and then add as ‚ÄúApproved‚Äù in the code later.</span>`;

        partnerName.value = "";
        partnerArea.value = "";
        partnerStorage.value = "";
        partnerContact.value = "";
      };

      function renderApprovedLocations() {
        // For now: none pre-filled (because you‚Äôre not sure yet).
        // Later, you‚Äôll hardcode verified partners here OR load from a real backend.
        approvedLocationsText.innerHTML =
          `None yet. We‚Äôre verifying partners. <span class="small muted">(Pilot mode)</span>`;
      }

      // --------- HELPERS ----------
      function safeParse(str, fallback) {
        try { return str ? JSON.parse(str) : fallback; } catch { return fallback; }
      }

      function todayKey() {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      }

      function containsBanned(textLower) {
        return BANNED_SUBSTRINGS.some(w => textLower.includes(w));
      }

      function looksLikeExactAddress(text) {
        const t = (text || "").toLowerCase();
        // crude heuristics: street numbers + common address terms
        const hasNumber = /\d{2,}/.test(t);
        const hasStreetWord = /(st\.|street|ave|avenue|rd\.|road|blvd|boulevard|lane|ln\.|drive|dr\.|suite|unit|apt|apartment)/.test(t);
        return hasNumber && hasStreetWord;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // Initial view
      show(screenHome);
    });
  </script>

</body>
</html>
